name: "🛠️ Full Build: Multi-Platform Config, Obfuscation, Catalog Automation"

on:
  push:
    paths:
      - "src-scripts/**/*.js"
      - "scripts/**/*.js"
      - "scripts/**/*.ts"
      - "scripts/**/*.sh"
      - "configs/master-rules.yaml"
      - "scripts/manifest-loader.html"
      - ".github/workflows/ci.yml"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      sha_short: ${{ steps.sha.outputs.sha_short }}
      build_version: ${{ env.BUILD_VERSION }}

    steps:
      - name: "📥 Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "🔑 Generate short SHA"
        id: sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: "🏗 Setup pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.0

      - name: "🛠️ Setup Node.js"
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: "📦 Install Dependencies"
        id: deps
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: "🔍 Audit dependencies"
        id: audit
        run: pnpm audit --audit-level=high || echo "::warning::Security vulnerabilities found"

      - name: "📝 Set build version"
        id: version
        run: echo "BUILD_VERSION=$(date +'%Y%m%d').${{ steps.sha.outputs.sha_short }}" >> $GITHUB_ENV

      - name: "🔨 Build all"
        id: build
        run: |
          chmod +x scripts/build-all.sh
          ./scripts/build-all.sh

      - name: "🗂 Copy manifest loader as index.html"
        id: copy-manifest
        run: |
          cp scripts/manifest-loader.html apps/loader/public/index.html

      - name: "🧪 Validate build artifacts"
        id: validate
        run: |
          if [ ! -d "./apps/loader/public" ]; then
            echo "::error::Build failed - public directory missing"
            exit 1
          fi
          
          empty_files=$(find ./apps/loader/public -type f \( -name "*.js" -o -name "*.json" \) -size 0)
          if [ ! -z "$empty_files" ]; then
            echo "::error::Empty files detected: $empty_files"
            exit 1
          fi

      - name: "📝 Commit & Push if changed"
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || (git commit -m "🤖 Auto-update configs/artifacts [skip ci]" -m "Build: ${{ env.BUILD_VERSION }}" && git push)

      - name: "📄 Setup Pages"
        id: pages
        uses: actions/configure-pages@v4

      - name: "📦 Upload Pages Artifact"
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./apps/loader/public"
          retention-days: 30

      - name: "🚀 Deploy to GitHub Pages"
        id: deployment
        uses: actions/deploy-pages@v4
