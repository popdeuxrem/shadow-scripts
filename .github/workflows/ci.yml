name: ğŸ› ï¸ Build & Deploy â€” Shadow Scripts

on:
  push:
    branches: [main]
    paths:
      - 'src-scripts/**'
      - 'scripts/**'
      - 'configs/master-rules.yaml'
      - 'scripts/manifest-loader.html'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write          # allow git push
  pages: write             # allow Pages deploy
  id-token: write          # required by deploy-pages

env:
  # fallback DNS for mobileconfig generator
  DNS_SERVER: "1.1.1.1"
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

#######################################################################
# 1ï¸âƒ£  BUILD job â€“ runs the full mono-repo build and uploads the Pages #
#######################################################################
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.sha.outputs.sha_short }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  checkout  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”‘ Short SHA
        id: sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  tool setup  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Set up pnpm
        uses: pnpm/action-setup@v4
        with: { version: 9.7.0 }

      - name: ğŸ› ï¸ Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¦ Install deps
        run: pnpm install --frozen-lockfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  build  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”¨ Build (configs + obfuscation + manifest + loader)
        run: |
          chmod +x scripts/build-all.sh
          ./scripts/build-all.sh
          cp scripts/manifest-loader.html apps/loader/public/index.html

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  validate  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Validate outputs
        run: |
          [ -d apps/loader/public ] || { echo "âŒ public dir missing"; exit 1; }
          find apps/loader/public -type f \( -name '*.js' -o -name '*.json' \) \
          | while read -r f; do [ -s "$f" ] || { echo "âŒ Empty file: $f"; exit 1; }; done

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  optional auto-commit  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Auto-commit artifacts (rebase-safe)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || {
            git commit -m "ğŸ¤– Build artifacts [skip ci]" -m "Build: ${{ steps.sha.outputs.sha_short }}"
            git pull --rebase origin main || true
            git push origin main || true
          }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  upload pages artifact  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/loader/public      # â† folder that becomes your site

#######################################################################
# 2ï¸âƒ£  DEPLOY job â€“ uses the new Pages action (needs build)           #
#######################################################################
  deploy:
    needs: build
    environment:
      name: github-pages
      url:  ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4    # official action  ğŸ“„ docs â†’  [oai_citation:0â€¡GitHub](https://github.com/actions/deploy-pages?utm_source=chatgpt.com)

#######################################################################
# 3ï¸âƒ£  (Optional) Discord notification                               #
#######################################################################
      - name: ğŸ“¢ Discord notify
        if: success() && env.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d "{\"content\":\"âœ… Shadow Scripts build ${{ needs.build.outputs.sha_short }} deployed: ${{ steps.deployment.outputs.page_url }}\"}" \
            "$DISCORD_WEBHOOK" || true
