on:
  push:
    paths:
      - 'src-scripts/**/*.js'
      - 'scripts/**/*.js'
      - 'scripts/*.ts'
      - 'scripts/index-template.html'
      - 'scripts/catalog-template.html'
      - '.github/workflows/update-index.yml'
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

name: 游대 Full Stealth Loader: Obfuscate, Generate, Deploy, Notify

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout
        uses: actions/checkout@v4

      - name: 游 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: 游닍 Install global tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g javascript-obfuscator

      - name: 游댏 Obfuscate and Base64-encode all spoof scripts (recursive, monorepo)
        run: |
          OUTDIR="apps/loader/public/obfuscated"
          SRCDIRS="src-scripts scripts/auth scripts/device scripts/finance scripts/location scripts/network scripts/security scripts/social"
          mkdir -p "$OUTDIR"
          find $SRCDIRS -type f -name "*.js" | while read f; do
            base=$(echo "$f" | sed 's|/|-|g' | sed 's|\.js$||')
            javascript-obfuscator "$f" --output "$OUTDIR/${base}.ob.js" --compact true --self-defending true --control-flow-flattening true
            base64 "$OUTDIR/${base}.ob.js" > "$OUTDIR/${base}.js.b64"
          done

      - name: 游대 Generate loader, manifest, catalog from templates
        run: |
          mkdir -p apps/loader/public/obfuscated
          mkdir -p apps/loader/public

          cd apps/loader/public/obfuscated
          files=$(find . -name "*.js.b64" | sed 's|^\./||g' | jq -R . | jq -s .)
          files_raw=$(find . -name "*.js.b64" | sort | sed 's|^\./||g')
          cd ../..

          # Loader index.html
          sed "s|__SPOOF_TARGETS__|$files|" scripts/index-template.html > apps/loader/public/index.html

          # manifest.json
          echo "$files" > apps/loader/public/manifest.json

          # catalog.html
          list_html=""
          for file in $files_raw; do
            list_html="$list_html<li><span class=\"url\">$file</span></li>"
          done
          sed "s|__CATALOG_LIST__|$list_html|" scripts/catalog-template.html > apps/loader/public/catalog.html

      - name: 游닋 Commit & Push if changed
        run: |
          git config user.name "popdeuxrem"
          git config user.email "174709939+popdeuxrem@users.noreply.github.com"
          git add apps/loader/public/obfuscated/ apps/loader/public/index.html apps/loader/public/manifest.json apps/loader/public/catalog.html
          git diff --cached --quiet || (git commit -m "游대 Obfuscate, generate, deploy [skip ci]" && git push)

      - name: 游 Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/loader/public
          publish_branch: gh-pages

      - name: 游눫 Discord notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          commit_url="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          num_scripts=$(ls apps/loader/public/obfuscated/*.js.b64 | wc -l)
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"username\": \"ShadowScriptsBot\", \"content\": \"Deployed $num_scripts spoof scripts. [View Commit]($commit_url) | [Catalog](https://popdeuxrem.github.io/shadow-scripts/catalog.html)\"}" \
            "$DISCORD_WEBHOOK"
