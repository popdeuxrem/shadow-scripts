name: 🔁 Stealth Loader: Obfuscate, Generate, Deploy, Notify (Bash Only)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 📦 Install global tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g javascript-obfuscator

      - name: 🔐 Obfuscate and Base64-encode all spoof scripts (recursive)
        run: |
          OUTDIR="apps/loader/public/obfuscated"
          SRCDIRS="src-scripts scripts/auth scripts/device scripts/finance scripts/location scripts/network scripts/security scripts/social"
          mkdir -p "$OUTDIR"
          find $SRCDIRS -type f -name "*.js" | while read f; do
            base=$(echo "$f" | sed 's|/|-|g' | sed 's|\.js$||')
            javascript-obfuscator "$f" --output "$OUTDIR/${base}.ob.js" --compact true --self-defending true --control-flow-flattening true
            base64 "$OUTDIR/${base}.ob.js" > "$OUTDIR/${base}.js.b64"
          done

      - name: 🔁 Generate loader, manifest, catalog with gen-configs.sh
        run: bash scripts/gen-configs.sh

      - name: 📤 Commit & Push if changed
        run: |
          git config user.name "popdeuxrem"
          git config user.email "174709939+popdeuxrem@users.noreply.github.com"
          git add apps/loader/public/obfuscated/ apps/loader/public/index.html apps/loader/public/manifest.json apps/loader/public/catalog.html
          git diff --cached --quiet || (git commit -m "🔁 Obfuscate, generate, deploy [skip ci]" && git push)

      - name: 🚀 Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/loader/public
          publish_branch: gh-pages

      - name: 💬 Discord notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          commit_url="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          num_scripts=$(ls apps/loader/public/obfuscated/*.js.b64 | wc -l)
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"username\": \"ShadowScriptsBot\", \"content\": \"Deployed $num_scripts spoof scripts. [View Commit]($commit_url) | [Catalog](https://popdeuxrem.github.io/shadow-scripts/catalog.html)\"}" \
            "$DISCORD_WEBHOOK"
