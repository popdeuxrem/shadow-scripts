name: 游대 Full Stealth Loader: Obfuscate, Generate, Deploy, Notify (TS)

on:
  push:
    paths:
      - 'src-scripts/**/*.js'
      - 'scripts/**/*.js'
      - 'scripts/*.ts'
      - 'scripts/index-template.html'
      - 'scripts/catalog-template.html'
      - '.github/workflows/update-index.yml'
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: 游닍 Install global tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g typescript ts-node javascript-obfuscator

      - name: 游댏 Obfuscate & base64 encode all spoof scripts
        run: |
          OUTDIR="apps/loader/public/obfuscated"
          SRCDIRS="src-scripts scripts/auth scripts/device scripts/finance scripts/location scripts/network scripts/security scripts/social"
          mkdir -p "$OUTDIR"
          find $SRCDIRS -type f -name "*.js" | while read f; do
            base=$(echo "$f" | sed 's|/|-|g' | sed 's|\.js$||')
            javascript-obfuscator "$f" --output "$OUTDIR/${base}.ob.js" --compact true --self-defending true --control-flow-flattening true
            base64 "$OUTDIR/${base}.ob.js" > "$OUTDIR/${base}.js.b64"
          done

      - name: 游 Generate loader, manifest, catalog using gen-configs.ts
        run: npx ts-node scripts/gen-configs.ts

      - name: 游닋 Commit & push changes (if any)
        run: |
          git config user.name "popdeuxrem"
          git config user.email "174709939+popdeuxrem@users.noreply.github.com"
          git add apps/loader/public/
          git diff --cached --quiet || (git commit -m "游대 Obfuscate, generate, deploy [skip ci]" && git push)

      - name: 游 Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/loader/public
          publish_branch: gh-pages

      - name: 游눫 Discord Notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          commit_url="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          num_scripts=$(ls apps/loader/public/obfuscated/*.js.b64 | wc -l)
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"username\": \"ShadowScriptsBot\", \"content\": \"游대 Deployed $num_scripts spoof scripts. [View Commit]($commit_url) | [Catalog](https://popdeuxrem.github.io/shadow-scripts/catalog.html)\"}" \
            "$DISCORD_WEBHOOK"
